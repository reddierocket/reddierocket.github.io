<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Learn Korean - Flashcards</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  .hidden { display: none; }
  .flashcard { border: 1px solid #ccc; padding: 10px; margin: 5px; border-radius: 6px; }
  .category-chip { display: inline-block; padding: 2px 6px; background: #eee; border-radius: 4px; margin-right: 5px; font-size: 0.85em; }
</style>
</head>
<body>

<h1>Flashcards</h1>
<p id="user-info"></p>

<!-- Add New Flashcard -->
<h2>Add Flashcard</h2>
<form id="add-card-form">
  <label>Korean: <input type="text" id="ko-text" required></label><br><br>
  <label>English: <input type="text" id="en-text" required></label><br><br>
  
  <label>Categories:
    <input type="text" id="category-search" placeholder="Search or create" list="category-options">
    <datalist id="category-options"></datalist>
  </label>
  <button type="button" id="add-category-btn">Add Category</button>
  <div id="selected-categories"></div>
  <br>
  
  <button type="submit">Save Card</button>
</form>

<hr>

<!-- Filters -->
<h2>Filters</h2>
<label>Date From: <input type="date" id="filter-date-from"></label>
<label>Date To: <input type="date" id="filter-date-to"></label>
<br><br>
<label>Filter Category:
  <input type="text" id="filter-category" list="filter-category-options">
  <datalist id="filter-category-options"></datalist>
</label>
<br><br>
<label><input type="checkbox" id="show-archived"> Show Archived</label>
<label><input type="checkbox" id="toggle-language"> Show Korean First</label>
<br><br>
<button id="apply-filters">Apply Filters</button>

<hr>

<!-- Flashcards Display -->
<div id="flashcards-list"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, updateDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDU71Csn0moQ8AGOsPIJOkVMAmVODzZiEU",
  authDomain: "rockthecat-d9617.firebaseapp.com",
  projectId: "rockthecat-d9617",
  storageBucket: "rockthecat-d9617.firebasestorage.app",
  messagingSenderId: "537950791174",
  appId: "1:537950791174:web:a5a2434536e3cf95f9c587"
};

// Init Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
let selectedCategories = [];
let standardCategories = [];
let privateCategories = [];

// Load user
onAuthStateChanged(auth, async (user) => {
  if (user) {
    currentUser = user;
    document.getElementById("user-info").textContent = `Signed in as ${user.email}`;
    await loadCategories();
    await loadFlashcards();
  } else {
    document.getElementById("user-info").textContent = "Not signed in.";
  }
});

// Load categories
async function loadCategories() {
  // Standard
  const stdSnap = await getDocs(collection(db, "categories", "standard", "items"));
  standardCategories = stdSnap.docs.map(doc => doc.id);

  // Private
  const privSnap = await getDocs(collection(db, "users", currentUser.uid, "categories"));
  privateCategories = privSnap.docs.map(doc => doc.id);

  updateCategoryLists();
}

function updateCategoryLists() {
  const catList = [...standardCategories, ...privateCategories];
  const options = document.getElementById("category-options");
  const filterOptions = document.getElementById("filter-category-options");
  options.innerHTML = "";
  filterOptions.innerHTML = "";
  catList.forEach(cat => {
    const opt = document.createElement("option");
    opt.value = cat;
    options.appendChild(opt);
    const opt2 = document.createElement("option");
    opt2.value = cat;
    filterOptions.appendChild(opt2);
  });
}

// Add category to selection
document.getElementById("add-category-btn").addEventListener("click", () => {
  const cat = document.getElementById("category-search").value.trim();
  if (cat && !selectedCategories.includes(cat)) {
    selectedCategories.push(cat);
    renderSelectedCategories();
  }
});

function renderSelectedCategories() {
  const container = document.getElementById("selected-categories");
  container.innerHTML = "";
  selectedCategories.forEach(cat => {
    const chip = document.createElement("span");
    chip.className = "category-chip";
    chip.textContent = cat;
    container.appendChild(chip);
  });
}

// Save card
document.getElementById("add-card-form").addEventListener("submit", async (e) => {
  e.preventDefault();
  const ko = document.getElementById("ko-text").value.trim();
  const en = document.getElementById("en-text").value.trim();

  await addDoc(collection(db, "users", currentUser.uid, "flashcards"), {
    ko, en,
    categories: selectedCategories,
    createdAt: serverTimestamp(),
    lastReviewed: null,
    archived: false
  });

  // Save any new private categories
  for (const cat of selectedCategories) {
    if (!standardCategories.includes(cat) && !privateCategories.includes(cat)) {
      await addDoc(collection(db, "users", currentUser.uid, "categories"), {});
    }
  }

  selectedCategories = [];
  renderSelectedCategories();
  document.getElementById("add-card-form").reset();
  await loadFlashcards();
});

// Load flashcards
async function loadFlashcards(filters = {}) {
  let q = collection(db, "users", currentUser.uid, "flashcards");
  const snap = await getDocs(q);
  const list = document.getElementById("flashcards-list");
  list.innerHTML = "";

  snap.forEach(docSnap => {
    const data = docSnap.data();
    if (!filters.showArchived && data.archived) return;

    // Date filter
    if (filters.from && data.createdAt?.toDate() < filters.from) return;
    if (filters.to && data.createdAt?.toDate() > filters.to) return;

    // Category filter
    if (filters.category && !data.categories.includes(filters.category)) return;

    const div = document.createElement("div");
    div.className = "flashcard";
    div.innerHTML = `
      <strong>${filters.showKoreanFirst ? data.ko : data.en}</strong><br>
      ${filters.showKoreanFirst ? data.en : data.ko}<br>
      Categories: ${data.categories.map(c => `<span class="category-chip">${c}</span>`).join("")}
    `;
    list.appendChild(div);
  });
}

// Apply filters
document.getElementById("apply-filters").addEventListener("click", () => {
  const filters = {
    from: document.getElementById("filter-date-from").value ? new Date(document.getElementById("filter-date-from").value) : null,
    to: document.getElementById("filter-date-to").value ? new Date(document.getElementById("filter-date-to").value) : null,
    category: document.getElementById("filter-category").value || null,
    showArchived: document.getElementById("show-archived").checked,
    showKoreanFirst: document.getElementById("toggle-language").checked
  };
  loadFlashcards(filters);
});
</script>

</body>
</html>
