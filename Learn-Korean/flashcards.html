<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Flashcards</title>
<style>
  body { font-family: sans-serif; max-width: 800px; margin: 2rem auto; }
  label, div { display: block; margin-top: 1rem; }
  input, select, textarea { width: 100%; padding: 0.5rem; margin-top: 0.3rem; }
  button { margin-top: 0.3rem; padding: 0.3rem 0.7rem; }
  .flashcard { border: 1px solid #ccc; padding: 0.5rem; margin-top: 0.5rem; }
</style>
</head>
<body>
<h1>Flashcards</h1>

<form id="flashcard-form">
  <label>
    Front (English/Korean):
    <input type="text" id="front" required>
  </label>

  <label>
    Back (Translation/Answer):
    <input type="text" id="back" required>
  </label>

  <label>
    Categories (select multiple with Ctrl/Cmd or type to search):
    <input type="text" id="category-search" placeholder="Search categories...">
    <select id="categories" multiple size="6"></select>
  </label>

  <button type="submit">Create Flashcard</button>
</form>

<h2>Filter Flashcards</h2>
<label>
  Show flashcards created after:
  <input type="date" id="filter-date">
</label>

<div id="flashcard-list"></div>
<div id="status"></div>

<script type="module">
import { auth, db } from "./firebase-setup.js";
import { collection, addDoc, serverTimestamp, query, where, getDocs, orderBy, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// Standard categories
const standardCategories = ["intro","medical","family","grammar","business","formal","sino","food","animals","activities","travel","vocabulary"];
let userCategories = []; // optionally load user-specific categories
const categoriesSelect = document.getElementById("categories");
const categorySearch = document.getElementById("category-search");

// Populate category list
function populateCategories() {
  categoriesSelect.innerHTML = "";
  [...standardCategories, ...userCategories].forEach(cat => {
    const option = document.createElement("option");
    option.value = cat;
    option.textContent = cat;
    categoriesSelect.appendChild(option);
  });
}

categorySearch.addEventListener("input", () => {
  const search = categorySearch.value.toLowerCase();
  [...categoriesSelect.options].forEach(opt => {
    opt.style.display = opt.value.toLowerCase().includes(search) ? "block" : "none";
  });
});

populateCategories();

// Create flashcard
document.getElementById("flashcard-form").addEventListener("submit", async (e) => {
  e.preventDefault();
  const user = auth.currentUser;
  if (!user) { alert("You must be signed in."); return; }

  const front = document.getElementById("front").value.trim();
  const back = document.getElementById("back").value.trim();
  const selectedCategories = [...categoriesSelect.selectedOptions].map(opt => opt.value);

  try {
    await addDoc(collection(db, "flashcards"), {
      front,
      back,
      categories: selectedCategories,
      ownerId: user.uid,
      createdAt: serverTimestamp()
    });
    document.getElementById("status").textContent = "✅ Flashcard created!";
    document.getElementById("flashcard-form").reset();
    loadFlashcards();
  } catch (error) {
    console.error(error);
    document.getElementById("status").textContent = "❌ Error creating flashcard.";
  }
});

// Load and display flashcards
let isAdmin = false;

async function loadFlashcards() {
  const user = auth.currentUser;
  if (!user) return;

  // check admin status
  const userDoc = await getDocs(doc(db, "users", user.uid));
  isAdmin = userDoc.exists && userDoc.data().isAdmin === true;

  const flashcardList = document.getElementById("flashcard-list");
  flashcardList.innerHTML = "";

  let q = query(collection(db, "flashcards"), orderBy("createdAt", "desc"));
  const filterDate = document.getElementById("filter-date").value;
  if (filterDate) {
    const date = new Date(filterDate);
    q = query(q, where("createdAt", ">", date));
  }

  const snapshot = await getDocs(q);
  snapshot.forEach(docSnap => {
    const data = docSnap.data();

    // Normal users see only their own cards
    if (!isAdmin && data.ownerId !== user.uid) return;

    const div = document.createElement("div");
    div.className = "flashcard";
    div.innerHTML = `
      <strong>${data.front}</strong> → ${data.back}<br>
      Categories: ${data.categories.join(", ")}<br>
      Owner: ${data.ownerId}<br>
      <button class="edit-btn">Edit</button>
      <button class="delete-btn">Delete</button>
    `;

    // Edit button
    div.querySelector(".edit-btn").addEventListener("click", async () => {
      const newFront = prompt("New front text:", data.front);
      const newBack = prompt("New back text:", data.back);
      const newCategories = prompt("New categories (comma-separated):", data.categories.join(","));
      if (newFront && newBack && newCategories !== null) {
        await updateDoc(doc(db, "flashcards", docSnap.id), {
          front: newFront,
          back: newBack,
          categories: newCategories.split(",").map(c => c.trim())
        });
        loadFlashcards();
      }
    });

    // Delete button
    div.querySelector(".delete-btn").addEventListener("click", async () => {
      if (confirm("Delete this flashcard?")) {
        await deleteDoc(doc(db, "flashcards", docSnap.id));
        loadFlashcards();
      }
    });

    flashcardList.appendChild(div);
  });
}

document.getElementById("filter-date").addEventListener("change", loadFlashcards);
auth.onAuthStateChanged(user => { if (user) loadFlashcards(); });
</script>
</body>
</html>
