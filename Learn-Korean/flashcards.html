<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Flashcards</title>
<style>
  body { font-family: sans-serif; max-width: 700px; margin: 2rem auto; }
  label { display: block; margin-top: 1rem; }
  input, select, textarea { width: 100%; padding: 0.5rem; margin-top: 0.3rem; }
  button { margin-top: 1rem; padding: 0.5rem 1rem; }
</style>
</head>
<body>
<h1>Create a Flashcard</h1>

<form id="flashcard-form">
  <label>
    Front (English/Korean):
    <input type="text" id="front" required>
  </label>

  <label>
    Back (Translation/Answer):
    <input type="text" id="back" required>
  </label>

  <label>
    Categories (select multiple with Ctrl/Cmd or type to search):
    <input type="text" id="category-search" placeholder="Search categories...">
    <select id="categories" multiple size="6"></select>
  </label>

  <button type="submit">Create Flashcard</button>
</form>

<h2>Filter Flashcards</h2>
<label>
  Show flashcards created after:
  <input type="date" id="filter-date">
</label>

<div id="flashcard-list"></div>
<div id="status"></div>

<script type="module">
import { auth, db } from "./firebase-setup.js";
import { collection, addDoc, serverTimestamp, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// Standard categories
const standardCategories = ["intro","medical","family","grammar","business","formal","sino","food","animals","activities","travel","vocabulary"];

let userCategories = []; // user-defined categories (load from db later if needed)
const categoriesSelect = document.getElementById("categories");
const categorySearch = document.getElementById("category-search");

// Populate category list
function populateCategories() {
  categoriesSelect.innerHTML = "";
  [...standardCategories, ...userCategories].forEach(cat => {
    const option = document.createElement("option");
    option.value = cat;
    option.textContent = cat;
    categoriesSelect.appendChild(option);
  });
}

// Filter categories by search
categorySearch.addEventListener("input", () => {
  const search = categorySearch.value.toLowerCase();
  [...categoriesSelect.options].forEach(opt => {
    opt.style.display = opt.value.toLowerCase().includes(search) ? "block" : "none";
  });
});

populateCategories();

// Create flashcard
document.getElementById("flashcard-form").addEventListener("submit", async (e) => {
  e.preventDefault();
  const user = auth.currentUser;
  if (!user) {
    alert("You must be signed in to create a flashcard.");
    return;
  }

  const front = document.getElementById("front").value.trim();
  const back = document.getElementById("back").value.trim();
  const selectedCategories = [...categoriesSelect.selectedOptions].map(opt => opt.value);

  try {
    await addDoc(collection(db, "flashcards"), {
      front,
      back,
      categories: selectedCategories,
      ownerId: user.uid,
      createdAt: serverTimestamp()
    });
    document.getElementById("status").textContent = "✅ Flashcard created!";
    document.getElementById("flashcard-form").reset();
  } catch (error) {
    console.error(error);
    document.getElementById("status").textContent = "❌ Error creating flashcard. Check console.";
  }

  loadFlashcards(); // refresh list
});

// Load and display flashcards
async function loadFlashcards() {
  const user = auth.currentUser;
  if (!user) return;

  const flashcardList = document.getElementById("flashcard-list");
  flashcardList.innerHTML = "";

  let q = query(collection(db, "flashcards"), orderBy("createdAt", "desc"));

  // Filter by date if selected
  const filterDate = document.getElementById("filter-date").value;
  if (filterDate) {
    const date = new Date(filterDate);
    q = query(q, where("createdAt", ">", date));
  }

  const snapshot = await getDocs(q);
  snapshot.forEach(doc => {
    const data = doc.data();
    // Only show cards owned by this user
    if (data.ownerId === user.uid) {
      const div = document.createElement("div");
      div.style.border = "1px solid #ccc";
      div.style.padding = "0.5rem";
      div.style.marginTop = "0.5rem";
      div.innerHTML = `<strong>${data.front}</strong> → ${data.back}<br>
                       Categories: ${data.categories.join(", ")}`;
      flashcardList.appendChild(div);
    }
  });
}

// Reload flashcards when date filter changes
document.getElementById("filter-date").addEventListener("change", loadFlashcards);

// Initial load when signed in
auth.onAuthStateChanged(user => {
  if (user) loadFlashcards();
});
</script>
</body>
</html>
