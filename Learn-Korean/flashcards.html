<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flashcards</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 800px; margin: auto; padding: 20px; background-color: #f5f5f5; }
  h1 { text-align: center; }
  #user-info { text-align: center; margin-bottom: 20px; font-weight: bold; }
  #controls { margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
  #card { text-align: center; font-size: 1.5em; padding: 20px; background: #fff; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 20px; }
  button { padding: 8px 12px; }
</style>
</head>
<body>

<h1>Flashcards</h1>
<p id="user-info"></p>
<button id="sign-out-button">Sign Out</button>

<div id="controls">
  <label>
    Filter by date:
    <select id="date-filter">
      <option value="all">All</option>
      <option value="today">Today</option>
      <option value="week">This Week</option>
      <option value="month">This Month</option>
    </select>
  </label>

  <label>
    Sort by:
    <select id="sort-method">
      <option value="lastReviewed">Last Reviewed</option>
      <option value="alphabetical">Alphabetical</option>
      <option value="random">Random</option>
    </select>
  </label>

  <label>
    <input type="checkbox" id="show-archived"> Show Archived
  </label>

  <label>
    <input type="checkbox" id="toggle-language"> Show English first
  </label>
</div>

<div id="card">Loading...</div>
<div style="text-align:center;">
  <button id="prev-card">⬅ Previous</button>
  <button id="next-card">Next ➡</button>
  <button id="archive-card">Archive / Unarchive</button>
  <button id="mark-reviewed">Mark Reviewed</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-auth.js";
  import { getFirestore, collection, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyDU71Csn0moQ8AGOsPIJOkVMAmVODzZiEU",
    authDomain: "rockthecat-d9617.firebaseapp.com",
    projectId: "rockthecat-d9617",
    storageBucket: "rockthecat-d9617.firebasestorage.app",
    messagingSenderId: "537950791174",
    appId: "1:537950791174:web:a5a2434536e3cf95f9c587"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const userInfo = document.getElementById("user-info");
  const signOutBtn = document.getElementById("sign-out-button");
  const cardDiv = document.getElementById("card");
  const prevBtn = document.getElementById("prev-card");
  const nextBtn = document.getElementById("next-card");
  const archiveBtn = document.getElementById("archive-card");
  const markReviewedBtn = document.getElementById("mark-reviewed");

  const dateFilter = document.getElementById("date-filter");
  const sortMethod = document.getElementById("sort-method");
  const showArchived = document.getElementById("show-archived");
  const toggleLanguage = document.getElementById("toggle-language");

  let flashcards = [];
  let filteredCards = [];
  let currentIndex = 0;

  onAuthStateChanged(auth, async user => {
    if (user) {
      userInfo.textContent = `Signed in as: ${user.email}`;
      await loadFlashcards();
      applyFilters();
      showCard();
    } else {
      window.location.href = "index.html";
    }
  });

  signOutBtn.addEventListener("click", () => signOut(auth));

  async function loadFlashcards() {
    const querySnapshot = await getDocs(collection(db, "flashcards"));
    flashcards = [];
    querySnapshot.forEach(docSnap => {
      const data = docSnap.data();
      data.id = docSnap.id;
      flashcards.push(data);
    });
  }

  function applyFilters() {
    const now = new Date();
    filteredCards = flashcards.filter(card => {
      if (!showArchived.checked && card.archived) return false;

      const created = new Date(card.createdAt);
      if (dateFilter.value === "today") {
        return created.toDateString() === now.toDateString();
      }
      if (dateFilter.value === "week") {
        const weekAgo = new Date(now);
        weekAgo.setDate(now.getDate() - 7);
        return created >= weekAgo;
      }
      if (dateFilter.value === "month") {
        return created.getMonth() === now.getMonth() && created.getFullYear() === now.getFullYear();
      }
      return true;
    });

    if (sortMethod.value === "lastReviewed") {
      filteredCards.sort((a,b) => new Date(a.lastReviewed || 0) - new Date(b.lastReviewed || 0));
    } else if (sortMethod.value === "alphabetical") {
      filteredCards.sort((a,b) => a.korean.localeCompare(b.korean));
    } else if (sortMethod.value === "random") {
      filteredCards.sort(() => Math.random() - 0.5);
    }

    currentIndex = 0;
  }

  function showCard() {
    if (filteredCards.length === 0) {
      cardDiv.textContent = "No cards to review.";
      return;
    }
    const card = filteredCards[currentIndex];
    cardDiv.textContent = toggleLanguage.checked ? card.english : card.korean;
  }

  prevBtn.addEventListener("click", () => {
    if (filteredCards.length === 0) return;
    currentIndex = (currentIndex - 1 + filteredCards.length) % filteredCards.length;
    showCard();
  });

  nextBtn.addEventListener("click", () => {
    if (filteredCards.length === 0) return;
    currentIndex = (currentIndex + 1) % filteredCards.length;
    showCard();
  });

  archiveBtn.addEventListener("click", async () => {
    if (filteredCards.length === 0) return;
    const card = filteredCards[currentIndex];
    card.archived = !card.archived;
    await updateDoc(doc(db, "flashcards", card.id), { archived: card.archived });
    applyFilters();
    showCard();
  });

  markReviewedBtn.addEventListener("click", async () => {
    if (filteredCards.length === 0) return;
    const card = filteredCards[currentIndex];
    card.lastReviewed = new Date().toISOString();
    card.reviewCount = (card.reviewCount || 0) + 1;
    await updateDoc(doc(db, "flashcards", card.id), { lastReviewed: card.lastReviewed, reviewCount: card.reviewCount });
    applyFilters();
    showCard();
  });

  dateFilter.addEventListener("change", () => { applyFilters(); showCard(); });
  sortMethod.addEventListener("change", () => { applyFilters(); showCard(); });
  showArchived.addEventListener("change", () => { applyFilters(); showCard(); });
  toggleLanguage.addEventListener("change", showCard);
</script>

</body>
</html>
