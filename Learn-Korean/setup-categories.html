<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Setup Categories</title> v 1
</head>
<body>
  <h1>Setup Standard Categories</h1>
  <button id="runBtn">Run Setup</button>
  <pre id="log" style="background:#eee; padding:10px; white-space:pre-wrap;"></pre>

  <script type="module">
    import { app, auth, db } from '../firebaseSetup.js';
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { collection, getDocs, doc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    function logMessage(message) {
      const logEl = document.getElementById("log");
      logEl.textContent += message + "\n";
      console.log(message); // still logs in console if available
    }

    async function setupCategoriesForAdmin() {
      try {
        logMessage("Starting setup...");

        const user = auth.currentUser;
        if (!user) {
          throw new Error("No user signed in.");
        }

        logMessage(`Signed in as: ${user.email}`);

        const categoriesRef = collection(db, "categories");
        const snapshot = await getDocs(categoriesRef);

        if (!snapshot.empty) {
          logMessage("Categories exist, updating ownerUid where missing...");
          let updates = 0;
          for (const cat of snapshot.docs) {
            const data = cat.data();
            if (!data.ownerUid) {
              await updateDoc(doc(db, "categories", cat.id), {
                ownerUid: user.uid
              });
              updates++;
            }
          }
          logMessage(`Updated ${updates} categories.`);
        } else {
          logMessage("No categories found, adding standard set...");
          const standardCats = [
            "intro", "medical", "family", "grammar", "business",
            "formal", "sino", "food", "animals", "activities",
            "travel", "vocabulary"
          ];
          for (const name of standardCats) {
            await setDoc(doc(categoriesRef), {
              name: name,
              isStandard: true,
              ownerUid: user.uid
            });
            logMessage(`Added category: ${name}`);
          }
        }

        logMessage("Setup complete!");
      } catch (err) {
        logMessage(`ERROR: ${err.message}`);
        console.error(err);
      }
    }

    document.getElementById("runBtn").addEventListener("click", setupCategoriesForAdmin);

    onAuthStateChanged(auth, (user) => {
      if (user) {
        logMessage(`User signed in: ${user.email}`);
      } else {
        logMessage("No user signed in. Please sign in first.");
      }
    });
  </script>
</body>
</html>
