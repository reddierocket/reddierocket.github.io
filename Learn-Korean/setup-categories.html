<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Setup Categories</title> v 21
</head>
<body>
  <h1>Setup Standard Categories</h1>
  
  <!-- no inline onclick anymore -->
  <button id="runBtn">Run Setup</button>
  
  <div id="log" style="border:1px solid #ccc; padding:10px; margin-top:10px;"></div>

  <script type="module">
    import { app, auth, db } from '../firebase-setup.js';
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { collection, getDocs, doc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    function logMessage(message) {
      const logDiv = document.getElementById("log");
      if (logDiv) {
        logDiv.innerHTML += message + "<br>";
      } else {
        alert("log element not found: " + message);
      }
    }

    async function setupCategoriesForAdmin() {
      try {
        logMessage("Starting setup...");

        const user = auth.currentUser;
        if (!user) {
          throw new Error("No user signed in.");
        }

        logMessage(`Signed in as: ${user.email}`);

        const categoriesRef = collection(db, "categories");
        logMessage("getting documents from categories");
        const snapshot = await getDocs(categoriesRef);
        logMessage("back from getting documents");

        if (!snapshot.empty) {
          logMessage("Categories exist, updating ownerUid where missing...");
          let updates = 0;
          for (const cat of snapshot.docs) {
            const data = cat.data();
            logMessage("category.name=" + cat.name + ", ownerUid=" + data.ownerUid);
            if (!data.ownerUid) {
              await updateDoc(doc(db, "categories", cat.id), {
                ownerUid: user.uid
              });
              logMessage("update for category successful: " + data.name);
              updates++;
            }
          }
          logMessage(`Updated ${updates} categories.`);
        } else {
          logMessage("No categories found, adding standard set...");
          const standardCats = [
            "intro", "medical", "family", "grammar", "business",
            "formal", "sino", "food", "animals", "activities",
            "travel", "vocabulary"
          ];
          for (const name of standardCats) {
            await setDoc(doc(categoriesRef), {
              name: name,
              isStandard: true,
              ownerUid: user.uid
            });
            logMessage(`Added category: ${name}`);
          }
        }

        logMessage("Setup complete!");
      } catch (err) {
        logMessage(`ERROR: ${err.message}`);
        console.error(err);
      }
    }

    onAuthStateChanged(auth, (user) => {
      if (user) {
        logMessage(`User signed in: ${user.email}`);
      } else {
        logMessage("No user signed in. Please sign in first.");
      }
    });
        logMessage("Setup complete!");

    // attach handler instead of inline onclick
    document.getElementById("runBtn").addEventListener("click", () => {
      logMessage("ready to run");
      setupCategoriesForAdmin();
    });

    
  
  </script>
</body>
</html>
